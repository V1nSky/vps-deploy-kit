name: üêç Deploy Python

on:
  push:
    branches:
      - main
      - develop
    tags:
      - 'v*'
  workflow_dispatch:

env:
  IMAGE_NAME: ${{ github.repository_owner }}/app-python
  CONTAINER_NAME: app-python

jobs:
  build-and-deploy:
    name: Build & Deploy
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üîç Detect environment
        id: env
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" || "${{ github.ref }}" == refs/tags/* ]]; then
            echo "name=production" >> $GITHUB_OUTPUT
            echo "url=${{ secrets.PROD_URL }}" >> $GITHUB_OUTPUT
            echo "host=${{ secrets.VPS_HOST }}" >> $GITHUB_OUTPUT
            echo "port=${{ secrets.APP_PORT || '8000' }}" >> $GITHUB_OUTPUT
          else
            echo "name=staging" >> $GITHUB_OUTPUT
            echo "url=${{ secrets.STAGING_URL }}" >> $GITHUB_OUTPUT
            echo "host=${{ secrets.VPS_HOST }}" >> $GITHUB_OUTPUT
            echo "port=${{ secrets.STAGING_PORT || '8001' }}" >> $GITHUB_OUTPUT
          fi

      - name: üîê Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ steps.env.outputs.host }} >> ~/.ssh/known_hosts

      - name: üèóÔ∏è Build Docker image
        run: |
          docker build \
            --cache-from ${{ env.IMAGE_NAME }}:latest \
            --tag ${{ env.IMAGE_NAME }}:${{ github.sha }} \
            --tag ${{ env.IMAGE_NAME }}:latest \
            .

      - name: üì¶ Save & transfer Docker image
        run: |
          docker save ${{ env.IMAGE_NAME }}:${{ github.sha }} | gzip | \
            ssh -o StrictHostKeyChecking=no \
            ${{ secrets.VPS_USER }}@${{ steps.env.outputs.host }} \
            "docker load"

      - name: üöÄ Deploy on VPS
        id: deploy
        run: |
          ssh ${{ secrets.VPS_USER }}@${{ steps.env.outputs.host }} bash << 'EOF'
            set -e

            CONTAINER="${{ env.CONTAINER_NAME }}"
            IMAGE="${{ env.IMAGE_NAME }}:${{ github.sha }}"
            PORT="${{ steps.env.outputs.port }}"

            # Save rollback point
            if docker ps -q -f name=$CONTAINER | grep -q .; then
              PREV=$(docker inspect $CONTAINER --format='{{.Image}}')
              echo $PREV > /tmp/${CONTAINER}_rollback
            fi

            docker stop $CONTAINER 2>/dev/null || true
            docker rm $CONTAINER 2>/dev/null || true

            ENV_FILE=""
            [ -f "/opt/app/.env" ] && ENV_FILE="--env-file /opt/app/.env"

            docker run -d \
              --name $CONTAINER \
              --restart unless-stopped \
              -p $PORT:8000 \
              $ENV_FILE \
              $IMAGE

            echo "Container started successfully"
          EOF

      - name: ‚ù§Ô∏è Health check
        id: health
        run: |
          sleep 10
          for i in {1..6}; do
            STATUS=$(ssh ${{ secrets.VPS_USER }}@${{ steps.env.outputs.host }} \
              "curl -s -o /dev/null -w '%{http_code}' http://localhost:${{ steps.env.outputs.port }}/health || echo 000")
            echo "Attempt $i: HTTP $STATUS"
            if [ "$STATUS" = "200" ]; then
              exit 0
            fi
            sleep 5
          done
          exit 1

      - name: üîô Rollback on failure
        if: failure() && steps.deploy.outcome == 'success'
        run: |
          ssh ${{ secrets.VPS_USER }}@${{ steps.env.outputs.host }} bash << 'EOF'
            CONTAINER="${{ env.CONTAINER_NAME }}"
            ROLLBACK_IMAGE=$(cat /tmp/${CONTAINER}_rollback 2>/dev/null || echo "")
            if [ -n "$ROLLBACK_IMAGE" ]; then
              docker stop $CONTAINER 2>/dev/null || true
              docker rm $CONTAINER 2>/dev/null || true
              docker run -d \
                --name $CONTAINER \
                --restart unless-stopped \
                -p ${{ steps.env.outputs.port }}:8000 \
                $ROLLBACK_IMAGE
              echo "Rolled back to: $ROLLBACK_IMAGE"
            fi
          EOF

      - name: üßπ Cleanup old images
        if: success()
        run: |
          ssh ${{ secrets.VPS_USER }}@${{ steps.env.outputs.host }} \
            "docker image prune -f --filter 'until=24h'"

      - name: ‚úÖ Notify success
        if: success()
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            ‚úÖ *–î–µ–ø–ª–æ–π —É—Å–ø–µ—à–µ–Ω!*
            
            üì¶ –ü—Ä–æ–µ–∫—Ç: `${{ github.repository }}`
            üåç –û–∫—Ä—É–∂–µ–Ω–∏–µ: `${{ steps.env.outputs.name }}`
            üîñ –ö–æ–º–º–∏—Ç: `${{ github.sha }}`
            üë§ –ê–≤—Ç–æ—Ä: `${{ github.actor }}`
            üîó URL: ${{ steps.env.outputs.url }}

      - name: ‚ùå Notify failure
        if: failure()
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            ‚ùå *–î–µ–ø–ª–æ–π —É–ø–∞–ª! –û—Ç–∫–∞—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω.*
            
            üì¶ –ü—Ä–æ–µ–∫—Ç: `${{ github.repository }}`
            üåç –û–∫—Ä—É–∂–µ–Ω–∏–µ: `${{ steps.env.outputs.name }}`
            üîñ –ö–æ–º–º–∏—Ç: `${{ github.sha }}`

  approve-production:
    name: ‚úã Approve Production
    runs-on: ubuntu-latest
    needs: build-and-deploy
    if: github.ref == 'refs/heads/main'
    environment:
      name: production
      url: ${{ secrets.PROD_URL }}
    steps:
      - name: Approved
        run: echo "Production deployment approved."
