name: ğŸ”™ Manual Rollback

on:
  workflow_dispatch:
    inputs:
      container_name:
        description: 'Container name to rollback'
        required: true
        default: 'app-nodejs'
      environment:
        description: 'Environment (production/staging)'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

jobs:
  rollback:
    name: ğŸ”™ Rollback
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ” Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: ğŸ”™ Execute rollback
        run: |
          ssh ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} bash << 'EOF'
            CONTAINER="${{ github.event.inputs.container_name }}"
            ROLLBACK_IMAGE=$(cat /tmp/${CONTAINER}_rollback 2>/dev/null || echo "")

            if [ -z "$ROLLBACK_IMAGE" ]; then
              echo "âŒ No rollback point found for $CONTAINER"
              exit 1
            fi

            echo "Rolling back $CONTAINER to: $ROLLBACK_IMAGE"

            docker stop $CONTAINER 2>/dev/null || true
            docker rm $CONTAINER 2>/dev/null || true

            docker run -d \
              --name $CONTAINER \
              --restart unless-stopped \
              $ROLLBACK_IMAGE

            echo "âœ… Rollback complete!"
          EOF

      - name: ğŸ”” Notify rollback
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            ğŸ”™ *Ğ ÑƒÑ‡Ğ½Ğ¾Ğ¹ Ğ¾Ñ‚ĞºĞ°Ñ‚ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½!*
            
            ğŸ“¦ ĞšĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€: `${{ github.event.inputs.container_name }}`
            ğŸŒ ĞĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ğµ: `${{ github.event.inputs.environment }}`
            ğŸ‘¤ Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ñ‚Ğ¾Ñ€: `${{ github.actor }}`
